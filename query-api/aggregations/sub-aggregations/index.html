<!DOCTYPE html>
<html lang="en" class="dark">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ElasticGraph Query API: Sub-Aggregations</title>
  <link rel="stylesheet" href="/elasticgraph/assets/css/main.css">
  <link rel="stylesheet" href="/elasticgraph/assets/css/highlight.css">
</head>

<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 flex flex-col h-screen">
  <!-- Navbar -->
<nav class="w-full py-4 bg-gray-200 dark:bg-gray-800 shadow">
  <div class="container mx-auto flex justify-between items-center px-4">
    <div class="text-xl flex items-center space-x-4">
      <a href="/elasticgraph/" class="font-bold hover:underline">ElasticGraph</a>
      <a href="/elasticgraph/getting-started" class="text-blue-600 dark:text-blue-400 hover:underline">Get Started</a>
      <a href="/elasticgraph/query-api" class="text-blue-600 dark:text-blue-400 hover:underline">Query API</a>
      <a href="/elasticgraph/docs/main" class="text-blue-600 dark:text-blue-400 hover:underline">Docs</a>

    </div>
    <div>
      <a href="https://github.com/block/elasticgraph" target="_blank"
        class="text-blue-600 dark:text-blue-400 hover:underline mr-2">GitHub</a>
      <a href="/elasticgraph/about" class="text-blue-600 dark:text-blue-400 hover:underline">About</a>
    </div>
  </div>

  <!-- Breadcrumbs -->
  <div class="container mx-auto px-4 mt-2">
    <nav class="text-base text-gray-600 dark:text-gray-400" aria-label="Breadcrumb">
      <ol class="list-reset flex">
        
        <li>
          <a href="/elasticgraph/" class="hover:underline">Home</a>
        </li>
        

        
        
        
          
          
          

          <li>
            <span class="mx-2">/</span>
            
              <a href="/elasticgraph/query-api/" class="hover:underline capitalize">
                ElasticGraph Query API
              </a>
            
          </li>
        
          
          
          

          <li>
            <span class="mx-2">/</span>
            
              <a href="/elasticgraph/query-api/aggregations/" class="hover:underline capitalize">
                Aggregations
              </a>
            
          </li>
        
          
          
          

          <li>
            <span class="mx-2">/</span>
            
              Sub-Aggregations
            
          </li>
        
      </ol>
    </nav>
  </div>
</nav>


  <main class="flex-grow">
    <div class="container mx-auto px-4 py-8 lg:py-20">
      <article class="prose dark:prose-invert lg:prose-xl">
        <h2>ElasticGraph Query API: Sub-Aggregations</h2>

        <p>The example schema used throughout this guide has a number of lists-of-object fields nested
within the overall <code class="language-plaintext highlighter-rouge">Artist</code> type:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Artist.albums</code>
    <ul>
      <li><code class="language-plaintext highlighter-rouge">Artist.albums[].tracks</code></li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">Artist.tours</code>
    <ul>
      <li><code class="language-plaintext highlighter-rouge">Artist.tours[].shows</code></li>
    </ul>
  </li>
</ul>

<p>ElasticGraph supports aggregations on these nested fields via <code class="language-plaintext highlighter-rouge">subAggregations</code>. This can be used
to aggregate directly on the data of one of these fields. For example, this query returns the
total sales for all albums of all artists:</p>

<figure class="highlight"><pre><code class="language-graphql" data-lang="graphql"><span class="k">query</span><span class="w"> </span><span class="n">TotalAlbumSales</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">artistAggregations</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">nodes</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="n">subAggregations</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="n">albums</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="n">nodes</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="n">aggregatedValues</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="n">soldUnits</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="n">exactSum</span><span class="w">
              </span><span class="p">}</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<p>Sub-aggregations can also be performed under the groupings of an outer aggregation. For example,
this query returns the total album sales grouped by the home country of the artist:</p>

<figure class="highlight"><pre><code class="language-graphql" data-lang="graphql"><span class="k">query</span><span class="w"> </span><span class="n">TotalAlbumSalesByArtistHomeCountry</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">artistAggregations</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">nodes</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="n">groupedBy</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="n">bio</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="n">homeCountry</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">

      </span><span class="n">subAggregations</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="n">albums</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="n">nodes</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="n">aggregatedValues</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="n">soldUnits</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="n">exactSum</span><span class="w">
              </span><span class="p">}</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<p>Sub-aggregation nodes offer the standard set of aggregation operations:</p>

<ul>
  <li><a href="/elasticgraph/query-api/aggregations/aggregated-values/">Aggregated Values</a></li>
  <li><a href="/elasticgraph/query-api/aggregations/counts/">Counts</a></li>
  <li><a href="/elasticgraph/query-api/aggregations/grouping/">Grouping</a></li>
  <li>Sub-aggregations</li>
</ul>

<h3 id="filtering-sub-aggregations">Filtering Sub-Aggregations</h3>

<p>The data included in a sub-aggregation can be filtered. For example, this query gets the total
sales of all albums released in the 21st century:</p>

<figure class="highlight"><pre><code class="language-graphql" data-lang="graphql"><span class="k">query</span><span class="w"> </span><span class="n">TwentyFirstCenturyAlbumSales</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">artistAggregations</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">nodes</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="n">subAggregations</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="n">albums</span><span class="p">(</span><span class="n">filter</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="n">releasedOn</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="n">gte</span><span class="p">:</span><span class="w"> </span><span class="s2">"2000-01-01"</span><span class="p">}</span><span class="w">
        </span><span class="p">})</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="n">nodes</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="n">aggregatedValues</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="n">soldUnits</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="n">exactSum</span><span class="w">
              </span><span class="p">}</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<h3 id="sub-aggregation-limitations">Sub-Aggregation Limitations</h3>

<p>Sub-aggregation pagination support is limited. You can use <code class="language-plaintext highlighter-rouge">first</code> to request how many
nodes are returned, but there is no <code class="language-plaintext highlighter-rouge">pageInfo</code> and you cannot request the next page of data:</p>

<figure class="highlight"><pre><code class="language-graphql" data-lang="graphql"><span class="k">query</span><span class="w"> </span><span class="n">AlbumSalesByReleaseMonth</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">artistAggregations</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">nodes</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="n">subAggregations</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="n">albums</span><span class="p">(</span><span class="n">first</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="n">nodes</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="n">groupedBy</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="n">releasedOn</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="n">asDate</span><span class="p">(</span><span class="n">truncationUnit</span><span class="p">:</span><span class="w"> </span><span class="n">MONTH</span><span class="p">)</span><span class="w">
              </span><span class="p">}</span><span class="w">
            </span><span class="p">}</span><span class="w">

            </span><span class="n">aggregatedValues</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="n">soldUnits</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="n">exactSum</span><span class="w">
              </span><span class="p">}</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<p>Sub-aggregation counts are approximate. Instead of <code class="language-plaintext highlighter-rouge">count</code>, ElasticGraph offers <code class="language-plaintext highlighter-rouge">countDetail</code>
with multiple subfields:</p>

<figure class="highlight"><pre><code class="language-graphql" data-lang="graphql"><span class="k">query</span><span class="w"> </span><span class="n">AlbumCount</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">artistAggregations</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">nodes</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="n">subAggregations</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="n">albums</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="n">nodes</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="n">countDetail</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="n">approximateValue</span><span class="w">
              </span><span class="n">exactValue</span><span class="w">
              </span><span class="n">upperBound</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<dl>
  <dt><code class="language-plaintext highlighter-rouge">approximateValue</code></dt>
  <dd>The (approximate) count of documents in this aggregation bucket.

    <p>When documents in an aggregation bucket are sourced from multiple shards, the count may be only
approximate. The <code class="language-plaintext highlighter-rouge">upperBound</code> indicates the maximum value of the true count, but usually
the true count is much closer to this approximate value (which also provides a lower bound on the
true count).</p>

    <p>When this approximation is known to be exact, the same value will be available from <code class="language-plaintext highlighter-rouge">exactValue</code>
and <code class="language-plaintext highlighter-rouge">upperBound</code>.</p>
  </dd>
  <dt><code class="language-plaintext highlighter-rouge">exactValue</code></dt>
  <dd>The exact count of documents in this aggregation bucket, if an exact value can be determined.

    <p>When documents in an aggregation bucket are sourced from multiple shards, it may not be possible to
efficiently determine an exact value. When no exact value can be determined, this field will be <code class="language-plaintext highlighter-rouge">null</code>.
The <code class="language-plaintext highlighter-rouge">approximateValue</code> field–which will never be <code class="language-plaintext highlighter-rouge">null</code>–can be used to get an approximation
for the count.</p>
  </dd>
  <dt><code class="language-plaintext highlighter-rouge">upperBound</code></dt>
  <dd>An upper bound on how large the true count of documents in this aggregation bucket could be.

    <p>When documents in an aggregation bucket are sourced from multiple shards, it may not be possible to
efficiently determine an exact value. The <code class="language-plaintext highlighter-rouge">approximateValue</code> field provides an approximation,
and this field puts an upper bound on the true count.</p>
  </dd>
</dl>

      </article>
    </div>
  </main>

  <!-- Footer -->
<footer class="bg-gray-200 dark:bg-gray-900 py-8">
  <div class="container mx-auto px-4 grid grid-cols-1 md:grid-cols-2 gap-8">
    <div>
      <h3 class="text-lg font-bold text-gray-900 dark:text-gray-100 mb-4">
        ElasticGraph
      </h3>
      <p class="text-gray-700 dark:text-gray-300">
        Schema-driven, scalable, cloud-native, batteries-included GraphQL with superpowers.
      </p>
      <p class="text-gray-700 dark:text-gray-300">
        Join our community and contribute on
        <a href="https://github.com/block/elasticgraph" class="text-blue-600 dark:text-blue-400 hover:underline">GitHub</a>.
      </p>
    </div>
  </div>
</footer>

</body>

</html>
